---
name: LinkML Linting GitHub Action
on:
  push:
    paths:
      - "src/mixs/schema/mixs.yaml"
jobs:
  linkml:
    permissions:
      contents: write
      pull-requests: write
    name: LinkML Linting
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1.3

      - name: Install dependencies
        run: poetry install --no-interaction --no-root
          
      - name: Run LinkML Linting
        run: |
          ## Results file header and basic formatting
          printf '# LinkML Linting Results \n' > linting-results.md
          printf "$(linkml --version) linting found the following issues: \n\n" >> linting-results.md

          ## Lint the schema, and further format
          linkml lint -f markdown src/mixs/schema/mixs.yaml >> linting-results.md
        # If the above check failed, post a comment on the PR explaining the failure
      - name: Reformat log
        if: failure()
        run: |
          sed -i -e 's/#### Errors/> [!CAUTION]/' -e 's/#### Warnings/> [!WARNING]/' -e 's/^*/> */' -e '/###.*yaml/ s/$/\n/' -e '/###.*yaml/ s/^###/**File**:/' linting-results.md
      - name: Post PR comment
        if: failure()
        uses: mshick/add-pr-comment@b8f338c590a895d50bcbfa6c5859251edc8952fc # v2
        with:
          message-path: linting-results.md
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          allow-repeats: true
